{% extends 'base.html' %}

{% block title %}{{ declaration.declaration_number }} - Zahnovia{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 class="page-title">
                <i class="fas fa-file-alt"></i> Konformitätserklärung
            </h1>
            <p class="page-subtitle">{{ declaration.declaration_number }}</p>
        </div>
        <a href="{% url 'declaration_list' %}" class="btn" style="background: #e2e8f0; color: #2d3748;">
            <i class="fas fa-arrow-left"></i> Zurück
        </a>
    </div>
</div>

<div class="card">
    <!-- Patienteninformationen -->
    <h2 class="card-title" style="border-bottom: 2px solid #17a2b8; padding-bottom: 10px; margin-bottom: 20px;">
        <i class="fas fa-user"></i> Patienteninformationen
    </h2>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div>
            <div style="color: #718096; font-size: 13px; margin-bottom: 5px; font-weight: 500;">Patientenname</div>
            <div style="font-size: 16px; font-weight: 600; color: #2d3748;">{{ declaration.patient_name|default:"—" }}</div>
        </div>
        <div>
            <div style="color: #718096; font-size: 13px; margin-bottom: 5px; font-weight: 500;">Auftragsnummer</div>
            <div style="font-size: 16px; font-weight: 600; color: #2d3748;">{{ declaration.auftragsnummer|default:"—" }}</div>
        </div>
        <div>
            <div style="color: #718096; font-size: 13px; margin-bottom: 5px; font-weight: 500;">Herstellungsdatum</div>
            <div style="font-size: 16px; font-weight: 600; color: #2d3748;">{{ declaration.herstellungsdatum|date:"d.m.Y"|default:"—" }}</div>
        </div>
        {% if hersteller_profile.verordnender_arzt %}
        <div>
            <div style="color: #718096; font-size: 13px; margin-bottom: 5px; font-weight: 500;">Verordnender Arzt</div>
            <div style="font-size: 16px; font-weight: 600; color: #2d3748;">{{ hersteller_profile.verordnender_arzt }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Produktbezeichnung / Arbeit -->
    <h2 class="card-title" style="border-bottom: 2px solid #17a2b8; padding-bottom: 10px; margin-bottom: 20px; margin-top: 40px;">
        <i class="fas fa-tooth"></i> Produktbezeichnung / Arbeit
    </h2>

    {% if declaration.product_works.all %}
    <table class="table" style="margin-bottom: 30px;">
        <thead>
            <tr>
                <th style="width: 60px;">Nr.</th>
                <th>Produktbezeichnung / Arbeit</th>
                <th style="width: 150px;">Zahnnummer</th>
                <th style="width: 150px;">Zahnfarbe</th>
            </tr>
        </thead>
        <tbody>
            {% for work in declaration.product_works.all %}
            <tr>
                <td style="text-align: center; font-weight: 600; color: #17a2b8;">{{ forloop.counter }}</td>
                <td style="font-weight: 600;">{{ work.produktbezeichnung_arbeit }}</td>
                <td>{{ work.zahnnummer|default:"—" }}</td>
                <td>{{ work.zahnfarbe|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #718096; padding: 20px; background: #f7fafc; border-radius: 6px; margin-bottom: 30px;">
        Keine Produktbezeichnung vorhanden.
    </p>
    {% endif %}

    <!-- Materialien -->
    <h2 class="card-title" style="border-bottom: 2px solid #17a2b8; padding-bottom: 10px; margin-bottom: 20px; margin-top: 40px;">
        <i class="fas fa-list"></i> Verwendete Materialien
    </h2>

    {% if declaration.items.all %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 50px;">Nr.</th>
                    <th style="min-width: 150px;">Material</th>
                    <th style="min-width: 150px;">Hersteller</th>
                    <th style="min-width: 200px;">Bestandteile</th>
                    <th style="width: 120px;">Lot No.</th>
                    <th style="width: 80px; text-align: center;">CE</th>
                </tr>
            </thead>
            <tbody>
                {% for item in declaration.items.all %}
                <tr>
                    <td style="text-align: center; font-weight: 600; color: #17a2b8;">{{ forloop.counter }}</td>
                    <td style="font-weight: 600;">{{ item.material }}</td>
                    <td>{{ item.firma }}</td>
                    <td style="font-size: 13px; color: #4a5568;">{{ item.bestandteile|default:"—" }}</td>
                    <td><code style="background: #f7fafc; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{{ item.material_lot_no }}</code></td>
                    <td style="text-align: center;">
                        {% if item.ce_status == "Ja" %}
                        <span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">✓ Ja</span>
                        {% else %}
                        <span style="background: #ef4444; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">✗ Nein</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="text-align: center; color: #718096; padding: 20px; background: #f7fafc; border-radius: 6px;">
        Keine Materialien vorhanden.
    </p>
    {% endif %}

    <!-- Footer Info -->
    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: #f7fafc; border-radius: 6px;">
            <div>
                <div style="color: #718096; font-size: 12px; margin-bottom: 3px;">Erklärungsnummer</div>
                <div style="font-size: 14px; font-weight: 600; color: #17a2b8;">{{ declaration.declaration_number }}</div>
            </div>
            <div>
                <div style="color: #718096; font-size: 12px; margin-bottom: 3px;">Praxis</div>
                <div style="font-size: 14px; font-weight: 600;">{{ declaration.praxis.username }}</div>
            </div>
            <div>
                <div style="color: #718096; font-size: 12px; margin-bottom: 3px;">Erstellt am</div>
                <div style="font-size: 14px; font-weight: 600;">{{ declaration.created_at|date:"d.m.Y H:i" }} Uhr</div>
            </div>
        </div>

        <div style="display: flex; gap: 15px;">
            {% if declaration.pdf_url %}
            <a href="{{ declaration.pdf_url }}" target="_blank" class="btn btn-primary">
                <i class="fas fa-file-pdf"></i> PDF Herunterladen
            </a>
            {% else %}
            <button class="btn" style="background: #ffc107; color: #fff;" disabled>
                <i class="fas fa-clock"></i> PDF wird generiert...
            </button>
            {% endif %}
            <a href="{% url 'declaration_list' %}" class="btn" style="background: #e2e8f0; color: #2d3748;">
                <i class="fas fa-list"></i> Zur Liste
            </a>
        </div>
    </div>
</div>
{% endblock %}
